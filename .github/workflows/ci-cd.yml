name: Build and Push Docker Image
on:
  push:
    branches: [main]
jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Login to DockerHub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/task-tracker:latest

      - name: Send Datadog Notification
        if: always()
        uses: datadog/agent-github-action@v1
        with:
          api_key: ${{ secrets.DATADOG_API_KEY }}
          app_key: ${{ secrets.DATADOG_APP_KEY }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Send Email Notification via Datadog
        if: always()
        env:
          DATADOG_API_KEY: ${{ secrets.DATADOG_API_KEY }}
        run: |
          status=${{ job.status }}

          curl -X POST "https://api.datadoghq.com/api/v1/events" \
            -H "Content-Type: application/json" \
            -H "DD-API-KEY: $DATADOG_API_KEY" \
            -d '{
              "title": "Docker Image Push '${{ job.status }}' for task-tracker",
              "text": "Docker image push workflow completed with status: '${{ job.status }}'\n\n' \
                      'Repository: ${{ github.repository }}\n' \
                      'Pushed Image: ${{ secrets.DOCKERHUB_USERNAME }}/task-tracker:latest\n' \
                      'Commit: ${{ github.sha }}\n' \
                      'Workflow Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
              "alert_type": "'"$([ \"$status\" = \"success\" ] && echo \"success\" || echo \"error\")"'"
            }'
